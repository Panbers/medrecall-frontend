<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assinatura - MedRecall</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
  <link rel="stylesheet" href="style.css" />
  <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>

<body class="bg-slate-900 flex items-center justify-center min-h-screen">
  <div id="content" class="w-full max-w-lg p-8 text-center bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
    <h2 class="text-3xl font-bold text-slate-200">Acesso Premium MedRecall</h2>
    <p class="mt-4 text-slate-400">
      Fa√ßa sua assinatura e desbloqueie todos os recursos.
    </p>

    <div class="mt-8 p-6 bg-slate-900 rounded-lg">
      <h3 class="text-xl font-semibold text-blue-400">Plano Anual</h3>
      <p class="mt-2 text-4xl font-bold text-white">R$ 165,90 <span class="text-lg text-slate-400">/ano</span></p>
    </div>

    <button id="subscribe-button"
      class="mt-8 w-full flex justify-center py-3 px-4 rounded-md text-lg font-medium text-white bg-blue-600 hover:bg-blue-700">
      Fazer Assinatura
    </button>

    <button id="logout-btn" class="mt-4 text-sm text-slate-500 hover:text-slate-400">Sair da conta</button>
  </div>

  <script src="config.js"></script>
  <script>
    const mp = new MercadoPago(window.ENV.MP_PUBLIC_KEY);
    const token = localStorage.getItem("authToken");

    async function createPixPayment() {
      const response = await fetch(`${window.ENV.API_URL}/api/payments/create`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({
          plan_name: "Assinatura Anual MedRecall",
          amount: 0.01,
        }),
      });

      const data = await response.json();
      console.log("üí∞ Resposta do pagamento:", data);

      const qrData = data?.point_of_interaction?.transaction_data;
      if (!qrData?.qr_code_base64) {
        alert("Erro ao criar pagamento PIX.");
        return;
      }

      showPixUI(qrData.qr_code_base64, qrData.qr_code);
    }

    function showPixUI(base64, pixCode) {
      const container = document.getElementById("content");
      container.innerHTML = `
        <h2 class="text-2xl font-bold text-slate-200 mb-4">Pagamento PIX</h2>
        <p class="text-slate-400 mb-4">Escaneie o QR Code abaixo ou copie o c√≥digo PIX para concluir o pagamento:</p>
        <img src="data:image/png;base64,${base64}" class="mx-auto mb-6 rounded-lg border border-slate-600 p-2 bg-white"/>

        <div class="bg-slate-900 rounded-lg p-4 mb-4 text-left">
          <p class="text-slate-300 text-sm break-words">${pixCode}</p>
        </div>
        <button id="copy-btn" class="w-full py-2 px-4 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
          Copiar c√≥digo PIX
        </button>

        <p id="timer" class="mt-4 text-slate-400">Expira em: <span class="text-white font-mono">10:00</span></p>
      `;

      document.getElementById("copy-btn").addEventListener("click", () => {
        navigator.clipboard.writeText(pixCode);
        alert("C√≥digo PIX copiado!");
      });

      startCountdown(600); // 10 minutos
    }

    function startCountdown(seconds) {
      const timerEl = document.querySelector("#timer span");
      const interval = setInterval(() => {
        seconds--;
        const m = String(Math.floor(seconds / 60)).padStart(2, "0");
        const s = String(seconds % 60).padStart(2, "0");
        timerEl.textContent = `${m}:${s}`;
        if (seconds <= 0) {
          clearInterval(interval);
          timerEl.textContent = "Expirado";
        }
      }, 1000);
    }

    document.getElementById("subscribe-button").addEventListener("click", createPixPayment);

    document.getElementById("logout-btn").addEventListener("click", () => {
      localStorage.removeItem("authToken");
      localStorage.removeItem("userData");
      window.location.href = "/index.html";
    });
  </script>
</body>
</html>
